#include <BMP280_DEV.h>
#include <Device.h>
#include <Wire.h>
#include <Servo.h>
#include <MPU9250.h>
#include <math.h>
#include <PID_v1.h>
#include <Arduino.h>
#include <VL53L0X.h>

#define PIN_INPUT 0
#define PIN_OUTPUT 2

double Setpoint_roll, Input_roll, Output_roll;
double Kp = 0.04, Kd = 0.9, Ki = 0.03;
PID myPID_roll(&Input_roll, &Output_roll, &Setpoint_roll, Kp, Ki, Kd, DIRECT);

float PWM_roll, PWM_yaw, PWM_pitch, PWM_thrust;

int PIN_1 = 2, PIN_2 = 3, PIN_3 = 4, PIN_4 = 5;
float PID_roll, PID_yaw, PID_pitch;
float temperature, pressure, altitudbar;
int altitudlaser;

Servo ESC1, ESC2, ESC3, ESC4;  // create servo object to control the ESC

BMP280_DEV bmp280;
MPU9250 mpu;
VL53L0X laseralt;

void setup()
{
  Serial.begin(9600);
  Wire.begin();

  laseralt.setTimeout(500);
  if (!laseralt.init())
  {
    Serial.println("Failed to detect and initialize sensor!");
    while (1) {}
  }
  laseralt.startContinuous(20);

  bmp280.begin(0X76);
  bmp280.setTimeStandby(TIME_STANDBY_1000MS);
  bmp280.startNormalConversion();
  mpu.setup();

  ESC1.attach(PIN_1, 1000, 2000); //CW 1
  ESC2.attach(PIN_2, 1000, 2000); //CW 3
  ESC3.attach(PIN_3, 1000, 2000); //CCW 2
  ESC4.attach(PIN_4, 1000, 2000); //CCW 4
  delay(7000);
  ESC1.write(0);
  ESC2.write(0);
  ESC3.write(0);
  ESC4.write(0);
  delay(3000);
  ESC1.write(180);
  ESC2.write(180);
  ESC3.write(180);
  ESC4.write(180);

  mpu.update();
  bmp280.getMeasurements(temperature, pressure, altitudbar);

  Input_roll = PID_roll;
  Setpoint_roll = 0;
  myPID_roll.SetMode(AUTOMATIC);

}

void loop()
{
  rollpitchyaw();
  altitud();
  PIDE();
}

void PIDE()
{
  Input_roll = PID_roll;
  myPID_roll.Compute();
  PWM_roll = map(Output_roll, 0, 255, 0, 180);
  ESC2.write(PWM_roll);//CCW
  ESC3.write(PWM_roll);//CW
  Serial.print(PWM_roll);
  Serial.print(" ");

  PID_roll = PID_roll - Kp;
  ESC1.write(PWM_roll);//CW
  ESC4.write(PWM_roll);//CCW
  Serial.print(PWM_roll);
  Serial.println(" ");
}

void rollpitchyaw()
{
  static uint32_t prev_ms = millis();
  if ((millis() - prev_ms) > 16)
  {
    mpu.update();
    PID_pitch = mpu.getPitch();
    PID_yaw = mpu.getYaw();
    PID_roll = mpu.getRoll();
    prev_ms = millis();
  }
}

void altitud()
{
  bmp280.getMeasurements(temperature, pressure, altitudbar);
  altitudlaser = laseralt.readRangeContinuousMillimeters();
}
